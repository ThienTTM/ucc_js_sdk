/* eslint-disable  */ require("../../css/style-caller.scss");const base_url="https://api.idg.vnpt.vn/router-service/api/",UUID="uuid",ROOM_INFO="roomInfo",PENDING="PENDING",ACCEPTED="ACCEPTED",REJECTED="REJECTED",FINISHED="FINISHED",TIMEOUT="TIMEOUT",DENIED="DENIED",LEAVE="LEAVE",ACCESS_TOKEN="access_token",errorCode={"IDG-00000000":"Thành công! - IDG-00000000","IDG-20000001":"Not null! - IDG-20000001","IDG-20000004":"Kích thước từ 0-255! - IDG-20000004","IDG-20000003":"Kích thước từ 0-4000! - IDG-20000003","IDG-20000005":"Kích thước từ 0-300! - IDG-20000005","IDG-20000006":"Không thuộc định dạng devicetype! - IDG-20000006","IDG-20000007":"Không thuộc định dạng statuscaller! - IDG-20000007","IDG-20000008":"Không thuộc kiểu enum môi trường! - IDG-20000008","IDG-20000100":"Không tìm thấy thiết bị người nhận! - IDG-20000100","IDG-20000201":"Cuộc gọi đang thực hiện! - IDG-20000201","IDG-20000202":"Không tìm thấy cuộc gọi! - IDG-20000202","IDG-20000203":"Người nhận đang trong cuộc gọi khác! - IDG-20000203","IDG-20000101":"Thiết bị người nhận và người gọi là 1! - IDG-20000101","IDG-20000210":"Không tìm thấy host! - IDG-20000210","IDG-20000404":"Không tìm thấy token! - IDG-20000404","IDG-20000211":"Không tìm thấy room! - IDG-20000211","IDG-20000213":"Không phải thiết bị nguồn! - IDG-20000213","IDG-20000214":"Không phải thiết bị đích! - IDG_20000214","IDG-20000215":"Không tồn tại cấu hình của token! - IDG_20000215","IDG-20000216":"Đã có lỗi xảy ra! - IDG-20000216","IDG-20000217":"Số lương thiết bị đăng ký vượt quá số lượng cho phép - IDG-20000217","IDG-20000218":"Thông tin người nhận không hợp lệ - IDG-20000218","IDG-20000219":"Không tìm thấy người gọi, nhận trong cuộc gọi - IDG-20000219","IDG-20000220":"Người nhận và người gọi là một người - IDG-20000220","IDG-20000420":"Cuộc gọi đã kết thúc - IDG-20000420","IDG-20000421":"Cuộc gọi bị từ chối - IDG-20000421","IDG-20000330":"Có lỗi xảy ra khi lấy file ghi âm - IDG-20000330","IDG-20000331":"Người gọi không có quyền truy cập file - IDG-20000331","IDG-20000232":"Cuộc gọi không có chế độ ghi âm, hình - IDG-20000332","IDG-20003001":"Lỗi socket time out - IDG-20000216","IDG-20003002":"Vui lòng kiểm tra kết nối mạng - IDG-20003002","IDG-20003003":"Lỗi kết nối: không kết nối được máy chủ! - IDG-20003003","IDG-20003004":"Lỗi kết nối: quá thời gian hồi đáp! - IDG-20003004","IDG-20003005":"Lỗi socket với message chi tiết - IDG-20003005","IDG-20003006":"Lỗi Java khác - IDG-20003006","IDG-20002400":"Token đã bị khoá - IDG-20002400","IDG-20002401":"Bạn không có quyền truy cập - IDG-20002401","IDG-20002402":"Quá số lượng cuộc gọi đồng thời cho phép - IDG-20002402","IDG-20002403":"Quá thời lượng cuộc gọi cho phép - IDG-20002403"},renderIframe='<div id="meet"></div>',receivingCalling='<div class="modal" id="receivingCalling">       <div class="modal-content">           <div class="modal-body">               <div class="col-12 mb-2 text-center">                   <span>Bạn có một cuộc gọi video từ admin hệ thống, Bạn có muốn nhận cuộc gọi ngay lúc này?</span>               </div>               <div class="row justify-content-center mx-2">                   <button id="acceptCall" type="button" class="btn btn-outline-primary mr-2" > Đồng ý</button>                   <button id="rejectCall" type="button" class="btn btn-outline-danger" data-dismiss="modal"> Hủy</button>                   </div>               </div>           </div>       </div></div>',msgModal='<div class="modal" id="msgModal" tabindex="-1" role="dialog">       <div class="modal-content">           <div class="modal-body">               <div class="col-12 mb-2 text-center">                  <i id="iconMsg" class="fas fa-exclamation-circle" style="color:red;font-size: 44px;"></i>               </div>               <div class="col-12 mb-2 text-center">                   <span ><b id="errMsg"></b></span>               </div>               <div class="row justify-content-center mx-2">                   <button id="closeBtn" type="button" class="btn btn-outline-primary" data-dismiss="modal"> Đóng</button>                   </div>               </div>           </div>       </div></div>',initModal='<div class="modal show" id="myModal" tabindex="-1" role="dialog">   <div class="modal-dialog" role="document">       <div class="modal-content">           <div class="modal-body">               <div class="row justify-content-center mb-2">                   <img id="avatar" src="" width="200" height="200" alt="avatar" style="border-radius:50%">               </div>               <div class="col-12 mb-2 text-center">                   <h4><label id="userName"></label></h4>               </div>               <div class="col-12 mb-2 text-center">                   <i class="fa fa-phone" aria-hidden="true"></i>                   <span><i>Đang gọi...</i></span>               </div>               <div class="col-12 mb-2 text-center">                   <span class="text-danger"><i>Cuộc gọi sẽ được tự động ghi lại</i></span>               </div>               <div class="row justify-content-center">                           <div class="ring" id="cancleCall">                               <div class="vdc-alo-phone vdc-alo-green vdc-alo-show" >                               <div class="vdc-alo-ph-circle"></div>                               <div class="vdc-alo-ph-circle-fill"></div>                               <div class="vdc-alo-ph-img-circle"></div>                           </div>               </div>           </div>       </div>   </div></div>',initModal2='<div class="modal" id="myModal">       <div class="modal-content">           <div class="modal-body">               <div class="row justify-content-center mb-2">                   <img id="avatar" src="" width="200" height="200" alt="avatar" style="border-radius:50%">               </div>               <div class="col-12 mb-2 text-center">                   <h4><label id="userName"></label></h4>               </div>               <div class="col-12 mb-2 text-center">                   <i class="fa fa-phone" aria-hidden="true"></i>                   <span><i>Đang gọi...</i></span>               </div>               <div class="col-12 mb-2 text-center">                   <span class="text-danger"><i>Cuộc gọi sẽ được tự động ghi lại</i></span>               </div>               <div class="row justify-content-center">                           <div class="ring" id="cancleCall">                               <div class="vdc-alo-phone vdc-alo-green vdc-alo-show" >                               <div class="vdc-alo-ph-circle"></div>                               <div class="vdc-alo-ph-circle-fill"></div>                               <div class="vdc-alo-ph-img-circle"></div>                           </div>               </div>           </div>       </div></div>',VideoCall=function(){let e,n=null,t=null,i=!1;function o(e,n,t){const i=document.getElementById("root");i?i.insertAdjacentHTML("afterbegin",receivingCalling):document.body.insertAdjacentHTML("afterbegin",receivingCalling);const o=document.getElementById("receivingCalling"),c=document.getElementById("acceptCall"),a=document.getElementById("rejectCall");c.onclick=function(){!async function(e,n){const t=JSON.parse(p(ROOM_INFO)),i={callerId:e,deviceId:h(),idgTokenId:n.token_id,roomId:t.roomId},o=await I(base_url+"v2/accept-call",i,n);"IDG-00000000"===o.message?s(e,n):y(o,o.message,null,"error")}(e,t),o.style.display="none"},a.onclick=function(){!async function(e,n){const t=JSON.parse(p(ROOM_INFO)),i={callerId:e,deviceId:h(),idgTokenId:n.token_id,roomId:t.roomId};await I(base_url+"v2/reject-call",i,n)}(e,t),o.style.display="none"},o.style.display="block"}function c(e,n){const t=document.getElementById("root");t?t.insertAdjacentHTML("afterbegin",msgModal):document.body.insertAdjacentHTML("afterbegin",msgModal);const i=document.getElementById("errMsg"),o=document.getElementById("iconMsg");"error"===e&&o?(o.className="fas fa-exclamation-circle",o.style.color="red"):(o.className="fas fa-check-circle",o.style.color="green"),i.innerText=n||"";const c=document.getElementById("closeBtn"),a=document.getElementById("msgModal");a.style.display="block",c.onclick=function(){a.style.display="none"}}function a(t,i){e=setTimeout(function(){m(t,i),n&&n.close(),r()},7e4)}function r(){clearTimeout(e)}function s(e,t){d();const o=void 0!==window.screenLeft?window.screenLeft:window.screenX,c=void 0!==window.screenTop?window.screenTop:window.screenY,a=window.innerWidth?window.innerWidth:document.documentElement.clientWidth?document.documentElement.clientWidth:window.screen.width,r=window.innerHeight?window.innerHeight:document.documentElement.clientHeight?document.documentElement.clientHeight:window.screen.height,s=a/window.screen.availWidth,l=(a-980)/2/s+o,g=(r-500)/2/s+c;JSON.parse(p(ROOM_INFO)).domain.replace("https://","");var h=window.open("call","_blank",`width=1280,height=600,top=${g},left=${l},menubar=yes,location=yes,resizable=yes,scrollbars=yes,status=yesnp`);n=h,window.addEventListener("offline",()=>{console.log("came offline inside open window"),n.close()}),n.onpageshow=(e=>{i=!0}),n.onpagehide=(n=>{i&&(m(e,t),i=!1)})}function d(){const e=document.getElementById("myModal"),n=document.getElementById("receivingCalling");e&&(e.style.display="none"),n&&(n.style.display="none")}function l(){return([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,e=>(e^crypto.getRandomValues(new Uint8Array(1))[0]&15>>e/4).toString(16))}function g(e,n){return n.token_id+"_"+e+"_"+h()}function h(){try{return p(UUID)&&p(UUID).replace(/"/g,"")}catch(e){y("","","Lỗi không xác định","error")}}async function m(e,n){d(),r();const t=JSON.parse(p(ROOM_INFO));let i;if(t){const o={callerId:e,deviceId:h(),idgTokenId:n.token_id,roomId:t.roomId};i=await I(base_url+"v2/end-call",o,n)}return i}async function u(e){const n={client_id:e.client_id,client_secret:e.client_secret,grant_type:"client_credentials"},i=await async function(e="",n={},t){try{p(ACCESS_TOKEN);const t=await fetch(e,{method:"POST",mode:"cors",cache:"no-cache",credentials:"same-origin",headers:{"Content-Type":"application/json"},redirect:"follow",referrerPolicy:"no-referrer",body:JSON.stringify(n)});return t.json()}catch(e){return e}}("https://api.idg.vnpt.vn/auth-service/oauth/token",n);return i.access_token&&(t="Bearer "+i.access_token),i}async function I(e="",n={},i){try{t||await u(i);const o=await fetch(e,{method:"POST",mode:"cors",cache:"no-cache",credentials:"same-origin",headers:{"Content-Type":"application/json;charset=UTF-8","Token-id":i.token_id,"Token-key":i.token_key,"mac-address":"WEB-001",Authorization:t},redirect:"follow",referrerPolicy:"no-referrer",body:JSON.stringify(n)});if(o.ok)return o.json();const c=await o.text();throw JSON.parse(c)}catch(t){return t&&"invalid_token"===t.error?(await u(i),I(e,n,i)):(y(t,t.message,null,"error"),t)}}async function v(e="",n="",i){try{t||await u(i);const o=await fetch(e,{method:"GET",mode:"cors",withCredentials:!0,cache:"no-cache",credentials:"same-origin",headers:{"Content-Type":"application/json","Token-id":i.token_id,"Token-key":i.token_key,"mac-address":"WEB-001",Authorization:t},redirect:"follow",referrerPolicy:"no-referrer"});if(o.ok)return o.json();const c=await o.text();throw JSON.parse(c)}catch(t){return t&&"invalid_token"===t.error?(await u(i),v(e,n,i)):(y(t,t.message,null,"error"),t)}}function y(e,n,t,i){e.error&&e.message&&errorCode[e.message]?c(i,errorCode[e.message]):e.error&&e.message&&!errorCode[e.message]?c(i,"Lỗi không xác định! Vui lòng thử lại"):t?c(i,t):"IDG-00000000"===e.message&&c(i,errorCode[e.message])}function D(e,n){try{return localStorage.setItem(e,JSON.stringify(n)),!0}catch(e){}}function p(e){try{return localStorage.getItem(e)}catch(e){}}return{getUUID:h,getTopicUsing:g,handleReceivingMessage:function(e,t,i){switch(function(){const e=document.getElementById("msgModal");e&&(e.style.display="none")}(),t.title){case ACCEPTED:return console.log("ACCEPTED"),void r();case PENDING:return console.log("PENDING"),D(ROOM_INFO,{roomId:t.roomId,token:t.token,domain:t.domain}),o(e,0,i),void a(e,i);case REJECTED:return console.log("REJECTED"),y("",0,"Cuộc gọi đã bị từ chối!",""),n&&n.close(),void d();case DENIED:return console.log("DENIED"),void d();case FINISHED:return console.log("FINISHED"),y("",0,"Cuộc gọi đã kết thúc!",""),n&&n.close(),void d();case TIMEOUT:return console.log("timeout"),n&&n.close(),void d();default:return}},removeDevice:async function(e,n){const i={deviceId:h(),idgTokenId:n.token_id,personIdApp:e,deviceTypeId:"WEB"},o=await async function e(n="",i={},o){try{t||await u(o);const c=await fetch(n,{method:"DELETE",mode:"cors",cache:"no-cache",credentials:"same-origin",headers:{"Content-Type":"application/json","Token-id":o.token_id,"Token-key":o.token_key,"mac-address":"WEB-001",Authorization:t},redirect:"follow",referrerPolicy:"no-referrer",body:JSON.stringify(i)});if(c.ok)return c.json();const a=await c.text();throw JSON.parse(a)}catch(t){return t&&"invalid_token"===t.error?(await u(o),e(n,i,o)):(y(t,t.message,null,"error"),t)}}(base_url+"v2/remove-device",i,n);return localStorage.removeItem(ROOM_INFO),localStorage.removeItem(ACCESS_TOKEN),o},createCall:async function(e,n="",t,i){try{const o={callerId:e,callerName:n,deviceId:h(),idgTokenId:i.token_id,reciverCallers:t},c=await I(base_url+"v2/create-call",o,i);return"IDG-00000000"===c.message?(D(ROOM_INFO,{roomId:c.object.roomId,token:c.object.token,domain:c.object.domain,caller:n}),s(e,i),a(e,i),c):c}catch(e){y("",0,"Đã có lỗi xảy ra","error")}},registerDevice:async function(e,n,t,i){const o={deviceId:h(),deviceToken:e,deviceTypeId:"WEB",idgTokenId:t.token_id,lastDate:new Date,personIdApp:n,personName:i,topicUsing:g(n,t)};return await u(t),await I(base_url+"v2/register-device",o,t)},endCall:m,createUUID:function(){return p(UUID)||D(UUID,l()),l()},getFile:async function(e,n){try{const t=JSON.parse(p(ROOM_INFO)),i=e||t.roomId;return await v(base_url+"v2/external/get-file?roomId="+i,"",n)}catch(e){console.log(e),y("",0,"Đã có lỗi xảy ra","error")}},getAuthen:u}};export default VideoCall;